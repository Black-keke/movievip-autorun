name: 🎬 Daily MovieVIP Task (8-10点随机)

on:
  schedule:
    - cron: '0 0 * * *' # 每天UTC时间00:00（北京时间08:00）触发
  workflow_dispatch:

jobs:
  generate-schedule:
    runs-on: ubuntu-latest
    outputs:
      random_minute: ${{ steps.set-random.outputs.minute }}
    steps:
      - name: Generate random minute between 0 and 120 (8:00-10:00)
        id: set-random
        run: echo "minute=$(($RANDOM % 120))" >> $GITHUB_OUTPUT

  create-and-run:
    needs: generate-schedule
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: gh auth login --with-token <<< "${{ secrets.GH_API_TOKEN }}"

      - name: Display random execution time
        run: |
          echo "🎲 今天任务将在 8点${{ needs.generate-schedule.outputs.random_minute }}分执行"
          echo "（8:00 + ${{ needs.generate-schedule.outputs.random_minute }}分钟）"

      - name: Create and Run Codespace
        timeout-minutes: 10
        run: |
          # 创建 codespace 但不等待它完全就绪（忽略 SSH 错误）
          gh codespace create --repo ${{ github.repository }} --branch main --machine basicLinux32gb --idle-timeout 5m --display-name "MovieVIP Runner" -s || echo "Codespace created successfully (SSH check ignored)"
          
          # 添加一个小延迟，确保 codespace 有足够时间启动
          sleep 30
        env:
          GH_TOKEN: ${{ secrets.GH_API_TOKEN }}
